pipeline {
    agent any
    
    environment {
        // Environment variables
        PYTHON_ENV = 'venv'
        SERVER_PORT = '8767'
        SERVER_HOST = '0.0.0.0'
        MAX_CONNECTIONS = '200'
        LOG_LEVEL = 'INFO'
        
        // Paths
        WORKSPACE_DIR = "${WORKSPACE}"
        VENV_PATH = "${WORKSPACE}/${PYTHON_ENV}"
        SERVER_SCRIPT = "run_tornado_server.py"
        PID_FILE = "${WORKSPACE}/tornado_server.pid"
        LOG_FILE = "${WORKSPACE}/tornado_server.log"
    }
    
    parameters {
        choice(
            name: 'ACTION',
            choices: ['start', 'stop', 'restart', 'status'],
            description: 'Action to perform on the Tornado server'
        )
        string(
            name: 'SERVER_PORT',
            defaultValue: '8767',
            description: 'Port number for the Tornado server'
        )
        string(
            name: 'MAX_CONNECTIONS',
            defaultValue: '200',
            description: 'Maximum number of concurrent connections'
        )
    }
    
    options {
        // Keep only last 10 builds
        buildDiscarder(logRotator(numToKeepStr: '10'))
        
        // Timeout the build after 30 minutes
        timeout(time: 30, unit: 'MINUTES')
        
        // Disable concurrent builds
        disableConcurrentBuilds()
    }
    
    stages {
        stage('Checkout Code') {
            when {
                anyOf {
                    expression { params.ACTION == 'start' }
                    expression { params.ACTION == 'restart' }
                }
            }
            steps {
                script {
                    echo "üîÑ Checking out latest code from GitHub..."
                    
                    // Clean workspace
                    deleteDir()
                    
                    // Checkout the repository
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[
                            url: 'https://github.com/scotthsiao/sample_gaming_sut.git'
                        ]],
                        extensions: [
                            [$class: 'CleanBeforeCheckout'],
                            [$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]
                        ]
                    ])
                    
                    echo "‚úÖ Code checkout completed"
                }
            }
        }
        
        stage('Setup Environment') {
            when {
                anyOf {
                    expression { params.ACTION == 'start' }
                    expression { params.ACTION == 'restart' }
                }
            }
            steps {
                script {
                    echo "üîß Setting up Python environment..."
                    
                    if (isUnix()) {
                        // Linux/macOS setup
                        sh '''
                            echo "Detecting system environment..."
                            
                            # Check if running in WSL
                            if grep -qi microsoft /proc/version 2>/dev/null || grep -qi wsl /proc/version 2>/dev/null; then
                                echo "üîç WSL (Windows Subsystem for Linux) detected"
                                WSL_DETECTED=true
                            else
                                WSL_DETECTED=false
                            fi
                            
                            echo "Detecting Python installation..."
                            
                            # Try to find Python executable
                            PYTHON_CMD=""
                            if command -v python3 >/dev/null 2>&1; then
                                PYTHON_CMD="python3"
                                echo "Found python3: $(which python3)"
                            elif command -v python >/dev/null 2>&1; then
                                PYTHON_VERSION=$(python --version 2>&1)
                                echo "Found python: $PYTHON_VERSION"
                                if echo "$PYTHON_VERSION" | grep -q "Python 3"; then
                                    PYTHON_CMD="python"
                                else
                                    echo "‚ùå Python 3 is required, found: $PYTHON_VERSION"
                                    exit 1
                                fi
                            else
                                echo "‚ùå Python not found. Please install Python 3.8 or higher"
                                echo "Available commands:"
                                which python* 2>/dev/null || echo "No python commands found"
                                
                                if [ "$WSL_DETECTED" = true ]; then
                                    echo ""
                                    echo "üîß WSL Installation Instructions:"
                                    echo "  Ubuntu/Debian WSL: sudo apt-get update && sudo apt-get install -y python3 python3-pip python3-venv"
                                    echo "  RHEL/CentOS WSL: sudo yum install -y python3 python3-pip"
                                    echo ""
                                    echo "Or run the setup script:"
                                    echo "  curl -sSL https://raw.githubusercontent.com/scotthsiao/sample_gaming_sut/main/jenkins/setup_jenkins_agent.sh | bash"
                                fi
                                
                                exit 1
                            fi
                            
                            echo "Using Python command: $PYTHON_CMD"
                            $PYTHON_CMD --version
                            
                            echo "Creating Python virtual environment..."
                            $PYTHON_CMD -m venv ${PYTHON_ENV}
                            
                            echo "Activating virtual environment..."
                            . ${PYTHON_ENV}/bin/activate
                            
                            echo "Python executable in venv: $(which python)"
                            python --version
                            
                            echo "Upgrading pip..."
                            python -m pip install --upgrade pip
                            
                            echo "Installing requirements..."
                            if [ -f requirements.txt ]; then
                                echo "Found requirements.txt, installing dependencies..."
                                pip install -r requirements.txt
                            else
                                echo "‚ùå requirements.txt not found"
                                ls -la
                                exit 1
                            fi
                            
                            echo "Checking for protoc..."
                            if command -v protoc >/dev/null 2>&1; then
                                echo "Found protoc: $(which protoc)"
                                protoc --version
                                
                                echo "Compiling Protocol Buffers..."
                                if [ -f proto/game_messages.proto ]; then
                                    protoc --python_out=. --pyi_out=. proto/game_messages.proto
                                    echo "‚úÖ Protocol Buffers compiled successfully"
                                else
                                    echo "‚ùå Protocol Buffers file not found: proto/game_messages.proto"
                                    ls -la proto/ 2>/dev/null || echo "proto/ directory not found"
                                    exit 1
                                fi
                            else
                                echo "‚ùå protoc not found. Please install Protocol Buffers compiler"
                                
                                if [ "$WSL_DETECTED" = true ]; then
                                    echo ""
                                    echo "üîß WSL Installation Instructions:"
                                    echo "  Ubuntu/Debian WSL: sudo apt-get install -y protobuf-compiler"
                                    echo "  RHEL/CentOS WSL: sudo yum install -y protobuf-compiler"
                                    echo ""
                                    echo "Or run the setup script:"
                                    echo "  curl -sSL https://raw.githubusercontent.com/scotthsiao/sample_gaming_sut/main/jenkins/setup_jenkins_agent.sh | bash"
                                else
                                    echo "  Ubuntu/Debian: sudo apt-get install protobuf-compiler"
                                    echo "  RHEL/CentOS: sudo yum install protobuf-compiler"
                                    echo "  macOS: brew install protobuf"
                                fi
                                
                                exit 1
                            fi
                            
                            echo "‚úÖ Environment setup completed successfully"
                        '''
                    } else {
                        // Windows setup
                        bat '''
                            echo Creating Python virtual environment...
                            python -m venv %PYTHON_ENV%
                            
                            echo Activating virtual environment and installing dependencies...
                            call %PYTHON_ENV%\\Scripts\\activate.bat
                            
                            echo Upgrading pip...
                            pip install --upgrade pip
                            
                            echo Installing requirements...
                            if exist requirements.txt (
                                pip install -r requirements.txt
                            ) else (
                                echo ‚ùå requirements.txt not found
                                exit /b 1
                            )
                            
                            echo Compiling Protocol Buffers...
                            if exist proto\\game_messages.proto (
                                protoc --python_out=. --pyi_out=. proto/game_messages.proto
                            ) else (
                                echo ‚ùå Protocol Buffers file not found
                                exit /b 1
                            )
                            
                            echo ‚úÖ Environment setup completed
                        '''
                    }
                }
            }
        }
        
        stage('Stop Server') {
            when {
                anyOf {
                    expression { params.ACTION == 'stop' }
                    expression { params.ACTION == 'restart' }
                }
            }
            steps {
                script {
                    echo "üõë Stopping Tornado server..."
                    
                    if (isUnix()) {
                        sh '''
                            if [ -f ${PID_FILE} ]; then
                                PID=$(cat ${PID_FILE})
                                echo "Found PID file with PID: $PID"
                                
                                if kill -0 $PID 2>/dev/null; then
                                    echo "Stopping server with PID: $PID"
                                    kill -TERM $PID
                                    
                                    # Wait up to 30 seconds for graceful shutdown
                                    for i in {1..30}; do
                                        if ! kill -0 $PID 2>/dev/null; then
                                            echo "‚úÖ Server stopped gracefully"
                                            break
                                        fi
                                        echo "Waiting for server to stop... ($i/30)"
                                        sleep 1
                                    done
                                    
                                    # Force kill if still running
                                    if kill -0 $PID 2>/dev/null; then
                                        echo "‚ö†Ô∏è  Force killing server with PID: $PID"
                                        kill -KILL $PID
                                        sleep 2
                                    fi
                                else
                                    echo "‚ö†Ô∏è  Process with PID $PID not running"
                                fi
                                
                                rm -f ${PID_FILE}
                            else
                                echo "‚ÑπÔ∏è  No PID file found - server may not be running"
                            fi
                            
                            # Kill any remaining processes
                            pkill -f "run_tornado_server.py" || true
                            pkill -f "tornado_game_server.py" || true
                            
                            echo "‚úÖ Server stop completed"
                        '''
                    } else {
                        bat '''
                            if exist %PID_FILE% (
                                set /p PID=<%PID_FILE%
                                echo Found PID file with PID: !PID!
                                
                                tasklist /fi "PID eq !PID!" 2>nul | find "!PID!" >nul
                                if !errorlevel! equ 0 (
                                    echo Stopping server with PID: !PID!
                                    taskkill /PID !PID! /T /F
                                    echo ‚úÖ Server stopped
                                ) else (
                                    echo ‚ö†Ô∏è  Process with PID !PID! not running
                                )
                                
                                del %PID_FILE%
                            ) else (
                                echo ‚ÑπÔ∏è  No PID file found - server may not be running
                            )
                            
                            REM Kill any remaining processes
                            taskkill /F /IM python.exe /FI "WINDOWTITLE eq *tornado*" 2>nul || echo No processes found
                            
                            echo ‚úÖ Server stop completed
                        '''
                    }
                }
            }
        }
        
        stage('Start Server') {
            when {
                anyOf {
                    expression { params.ACTION == 'start' }
                    expression { params.ACTION == 'restart' }
                }
            }
            steps {
                script {
                    echo "üöÄ Starting Tornado server..."
                    
                    if (isUnix()) {
                        sh '''#!/bin/bash
                            echo "Starting Tornado server on port ${SERVER_PORT}..."
                            
                            # Clean up any existing server instances first
                            echo "üßπ Cleaning up existing server instances..."
                            
                            if [ -f ${PID_FILE} ]; then
                                OLD_PID=$(cat ${PID_FILE})
                                echo "Found existing PID file with PID: $OLD_PID"
                                
                                if kill -0 $OLD_PID 2>/dev/null; then
                                    echo "Stopping existing server process $OLD_PID..."
                                    kill $OLD_PID 2>/dev/null || true
                                    sleep 2
                                    
                                    # Force kill if still running
                                    if kill -0 $OLD_PID 2>/dev/null; then
                                        echo "Force killing process $OLD_PID..."
                                        kill -9 $OLD_PID 2>/dev/null || true
                                        sleep 1
                                    fi
                                else
                                    echo "Process $OLD_PID not running"
                                fi
                                
                                rm -f ${PID_FILE}
                            fi
                            
                            # Kill any remaining processes by name
                            echo "Cleaning up any remaining tornado processes..."
                            pkill -f "run_tornado_server.py" 2>/dev/null || true
                            pkill -f "tornado_game_server.py" 2>/dev/null || true
                            sleep 1
                            
                            echo "‚úÖ Cleanup completed"
                            
                            # Activate virtual environment
                            . ${PYTHON_ENV}/bin/activate
                            
                            # Use classic nohup approach for process isolation
                            echo "Starting server with nohup..."
                            nohup python3 ${SERVER_SCRIPT} \\
                                --host ${SERVER_HOST} \\
                                --port ${SERVER_PORT} \\
                                --max-connections ${MAX_CONNECTIONS} \\
                                < /dev/null > ${LOG_FILE} 2>&1 &
                            
                            # Store PID
                            echo \$! > ${PID_FILE}
                            PID=\$(cat ${PID_FILE})
                            echo "Server started with nohup, PID: \$PID"
                            
                            # Verify server started successfully
                            if [ -f ${PID_FILE} ]; then
                                PID=$(cat ${PID_FILE})
                                echo "‚úÖ Server daemon setup completed"
                                echo "Server PID: $PID"
                                echo "Log file: ${LOG_FILE}"  
                                echo "PID file: ${PID_FILE}"
                                echo "Server accessible at: ws://${SERVER_HOST}:${SERVER_PORT}"
                            else
                                echo "‚ùå Daemon script failed"
                                exit 1
                            fi
                        '''
                    } else {
                        bat '''
                            echo Starting Tornado server on port %SERVER_PORT%...
                            
                            REM Clean up any existing server instances first
                            echo üßπ Cleaning up existing server instances...
                            
                            if exist %PID_FILE% (
                                set /p OLD_PID=<%PID_FILE%
                                echo Found existing PID file with PID: !OLD_PID!
                                
                                REM Check if process is running and kill it
                                tasklist /FI "PID eq !OLD_PID!" 2>NUL | find "!OLD_PID!" >NUL
                                if !ERRORLEVEL! EQU 0 (
                                    echo Stopping existing server process !OLD_PID!...
                                    taskkill /PID !OLD_PID! /F 2>NUL
                                    timeout /t 1 /nobreak >NUL
                                ) else (
                                    echo Process !OLD_PID! not running
                                )
                                
                                del /Q %PID_FILE% 2>NUL
                            )
                            
                            REM Kill any remaining tornado processes
                            echo Cleaning up any remaining tornado processes...
                            taskkill /F /IM python.exe /FI "WINDOWTITLE eq *tornado*" 2>NUL
                            taskkill /F /IM python.exe /FI "COMMANDLINE eq *run_tornado_server*" 2>NUL
                            timeout /t 1 /nobreak >NUL
                            
                            echo ‚úÖ Cleanup completed
                            
                            REM Activate virtual environment
                            call %PYTHON_ENV%\\Scripts\\activate.bat
                            
                            REM Start server in background
                            start /B python %SERVER_SCRIPT% ^
                                --host %SERVER_HOST% ^
                                --port %SERVER_PORT% ^
                                --max-connections %MAX_CONNECTIONS% ^
                                > %LOG_FILE% 2>&1
                            
                            REM Get PID (Windows approach)
                            timeout /t 2 /nobreak > nul
                            for /f "tokens=2" %%i in ('tasklist /fi "imagename eq python.exe" /fo csv ^| find "python.exe"') do (
                                echo %%i > %PID_FILE%
                                set PID=%%i
                                goto :found
                            )
                            :found
                            
                            echo Server started with approximate PID: %PID%
                            echo Log file: %LOG_FILE%
                            echo PID file: %PID_FILE%
                            
                            REM Wait for server to start
                            timeout /t 5 /nobreak > nul
                            
                            echo ‚úÖ Server startup initiated
                            echo Server should be accessible at: ws://%SERVER_HOST%:%SERVER_PORT%
                        '''
                    }
                }
            }
        }
        
        stage('Server Status') {
            steps {
                script {
                    echo "üìä Checking Tornado server status..."
                    
                    if (isUnix()) {
                        sh '''
                            echo "=== SERVER STATUS ==="
                            
                            if [ -f ${PID_FILE} ]; then
                                PID=$(cat ${PID_FILE})
                                echo "PID file exists: ${PID_FILE}"
                                echo "Stored PID: $PID"
                                
                                if kill -0 $PID 2>/dev/null; then
                                    echo "‚úÖ Server is RUNNING (PID: $PID)"
                                    
                                    # Show process info
                                    ps aux | grep $PID | grep -v grep || true
                                    
                                    # Show listening ports
                                    echo "\\n--- Listening Ports ---"
                                    netstat -tlnp 2>/dev/null | grep :${SERVER_PORT} || echo "No port ${SERVER_PORT} found"
                                    
                                else
                                    echo "‚ùå Server is NOT RUNNING (PID $PID not found)"
                                fi
                            else
                                echo "‚ÑπÔ∏è  No PID file found"
                                echo "‚ùì Server status UNKNOWN"
                            fi
                            
                            # Show recent log entries
                            if [ -f ${LOG_FILE} ]; then
                                echo "\\n--- Recent Log Entries (last 10 lines) ---"
                                tail -n 10 ${LOG_FILE}
                            else
                                echo "‚ÑπÔ∏è  No log file found: ${LOG_FILE}"
                            fi
                            
                            # Show all Python processes (for debugging)
                            echo "\\n--- All Python/Tornado Processes ---"
                            ps aux | grep -E "(python|tornado)" | grep -v grep || echo "No Python processes found"
                        '''
                    } else {
                        bat '''
                            echo === SERVER STATUS ===
                            
                            if exist %PID_FILE% (
                                set /p PID=<%PID_FILE%
                                echo PID file exists: %PID_FILE%
                                echo Stored PID: !PID!
                                
                                tasklist /fi "PID eq !PID!" 2>nul | find "!PID!" >nul
                                if !errorlevel! equ 0 (
                                    echo ‚úÖ Server is RUNNING ^(PID: !PID!^)
                                    tasklist /fi "PID eq !PID!"
                                ) else (
                                    echo ‚ùå Server is NOT RUNNING ^(PID !PID! not found^)
                                )
                            ) else (
                                echo ‚ÑπÔ∏è  No PID file found
                                echo ‚ùì Server status UNKNOWN
                            )
                            
                            REM Show listening ports
                            echo.
                            echo --- Listening Ports ---
                            netstat -an | find ":%SERVER_PORT%" || echo No port %SERVER_PORT% found
                            
                            REM Show recent log entries
                            if exist %LOG_FILE% (
                                echo.
                                echo --- Recent Log Entries ^(last 10 lines^) ---
                                powershell "Get-Content '%LOG_FILE%' -Tail 10"
                            ) else (
                                echo ‚ÑπÔ∏è  No log file found: %LOG_FILE%
                            )
                            
                            REM Show all Python processes
                            echo.
                            echo --- All Python Processes ---
                            tasklist /fi "imagename eq python.exe" || echo No Python processes found
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "üèÅ Build completed for action: ${params.ACTION}"
                
                // Archive logs if they exist
                if (fileExists("${LOG_FILE}")) {
                    archiveArtifacts artifacts: "*.log", fingerprint: true, allowEmptyArchive: true
                }
                
                // Clean up old logs (keep last 5)
                if (isUnix()) {
                    sh '''
                        find . -name "tornado_server_*.log" -type f -mtime +5 -delete || true
                    '''
                } else {
                    bat '''
                        forfiles /m tornado_server_*.log /d -5 /c "cmd /c del @path" 2>nul || echo No old logs to clean
                    '''
                }
            }
        }
        
        success {
            echo "‚úÖ Jenkins job completed successfully!"
        }
        
        failure {
            script {
                echo "‚ùå Jenkins job failed!"
                
                // Show error logs if available
                if (fileExists("${LOG_FILE}")) {
                    if (isUnix()) {
                        sh "echo '--- Error Log Contents ---' && cat ${LOG_FILE}"
                    } else {
                        bat "echo --- Error Log Contents --- && type %LOG_FILE%"
                    }
                }
            }
        }
        
        cleanup {
            script {
                echo "üßπ Performing cleanup..."
                // Note: We intentionally don't clean the workspace to preserve the server state
                // Only clean temporary files if needed
            }
        }
    }
}